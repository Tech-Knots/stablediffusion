# ---- Stable Diffusion Demo (Clean Version) ----
from diffusers import StableDiffusionPipeline
import torch
import os

# ‚úÖ Ask for Hugging Face token (one time)
hf_token = input("Enter your Hugging Face token: ").strip()

# ‚úÖ Detect device (GPU / CPU)
device = "cuda" if torch.cuda.is_available() else "cpu"

# ‚úÖ Load Stable Diffusion safely
pipe = StableDiffusionPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5",
    use_safetensors=True,
    torch_dtype=torch.float16 if device == "cuda" else torch.float32,
    token=hf_token
).to(device)

# ‚úÖ Create output folder
os.makedirs("outputs", exist_ok=True)

print("\n‚úÖ Stable Diffusion ready!")
print("Type 'exit' anytime to stop generating images.\n")

# ‚úÖ Image generation loop
count = 1
while True:
    prompt = input("Enter your image prompt (or type 'exit' to quit): ").strip()
    if prompt.lower() == "exit":
        print("üëã Exiting gracefully...")
        break

    print("üé® Generating image... please wait.")
    image = pipe(prompt).images[0]

    filename = f"outputs/output_{count}.png"
    image.save(filename)
    print(f"‚úÖ Image saved as {filename}\n")

    # Try to show image (if supported)
    try:
        image.show()
    except Exception:
        print("‚ö†Ô∏è Image preview not supported here, but saved successfully!")

    count += 1
